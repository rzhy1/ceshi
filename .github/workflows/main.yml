name: "ÊµãËØï"

on:
  workflow_dispatch:
  push:
    branches: ["*"]
  pull_request:
    branches: ["*"]
  release:
    types: [released]
  schedule:
    - cron: "0 0 * * *"

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      - name: üöÄ ÊµãËØïÂπ∂ÊòæÁ§∫ÊúÄÂø´ÁöÑ Ubuntu Ê∫êÔºà‰ΩøÁî® curl ÊµãÈÄüÔºâ
        run: |
          echo "‚è≥ ÂáÜÂ§áÊµãËØïÁéØÂ¢É..."

          echo ""
          echo "üåê Ëé∑ÂèñÂÆòÊñπÈïúÂÉèÂàóË°®ÔºàÂº∫Âà∂Ëé∑ÂèñÂÆåÊï¥ÂàóË°®Ôºâ..."
          MIRRORS=$(wget -qO- "http://mirrors.ubuntu.com/mirrors.txt?all=true")
          MIRROR_COUNT=$(echo "$MIRRORS" | wc -l)
          echo "üîç ÂÖ±Ëé∑ÂèñÂà∞ $MIRROR_COUNT ‰∏™ÈïúÂÉèÊ∫êÔºåÂºÄÂßãÊµãËØï..."

          if [ "$MIRROR_COUNT" -lt 2 ]; then
            echo "‚ö†Ô∏è  ÈïúÂÉèÂàóË°®ËøáÂ∞ëÔºåË°•ÂÖÖÂ∏∏Áî®Âø´ÈÄüÈïúÂÉè..."
            MIRRORS=$(echo -e "$MIRRORS\nhttp://mirrors.aliyun.com/ubuntu/\nhttp://mirrors.tuna.tsinghua.edu.cn/ubuntu/\nhttp://mirror.sjtu.edu.cn/ubuntu/")
            MIRROR_COUNT=$(echo "$MIRRORS" | wc -l)
            echo "üìå Ë°•ÂÖÖÂêéÂÖ± $MIRROR_COUNT ‰∏™ÈïúÂÉèÊ∫ê„ÄÇ"
          fi

          echo ""
          echo "üìã ÈïúÂÉèÊ∫êÂàóË°®Ôºö"
          echo "$MIRRORS" | nl

          echo ""
          echo "‚è±Ô∏è  Ê≠£Âú®ÊµãËØï HTTP ÂìçÂ∫îÈÄüÂ∫¶ÔºàË∂äÂ∞èË∂äÂø´Ôºâ..."

          # ÂàõÂª∫‰∏¥Êó∂Êñá‰ª∂Â≠òÂÇ®ÁªìÊûú
          TEMP_RESULTS=$(mktemp)

          # ÈÄê‰∏™ÊµãËØï
          while IFS= read -r url; do
            if [ -z "$url" ]; then continue; fi
            # ÊèêÂèñ‰∏ªÊú∫ÂêçÁî®‰∫éÊòæÁ§∫
            host=$(echo "$url" | sed -E 's|https?://([^/]+).*|\1|')
            # ÊµãËØïÈ¶ñÈ°µÊàñ /README ÂìçÂ∫îÊó∂Èó¥ÔºàËΩªÈáèÔºâ
            test_url="${url%/}/README"
            time_total=$(curl -w "%{time_total}" -o /dev/null -s --connect-timeout 10 --max-time 20 "$test_url" 2>/dev/null || echo "999.999")
            if [ "$time_total" = "0.000" ] || [ -z "$time_total" ]; then
              time_total="999.999"
            fi
            printf "%.3f   %s\n" "$time_total" "$host" >> "$TEMP_RESULTS"
            echo "  ‚Üí $host : ${time_total}s"
          done <<< "$MIRRORS"

          # ÊåâÂìçÂ∫îÊó∂Èó¥ÊéíÂ∫è
          echo ""
          echo "üìä ÊµãËØïÁªìÊûúÔºàÂìçÂ∫îÊó∂Èó¥ÔºåÂçï‰ΩçÔºöÁßíÔºåË∂äÂ∞èË∂äÂ•ΩÔºâÔºö"
          sort -n "$TEMP_RESULTS" | head -n 10 | awk '{printf "%7s   %s\n", $1, $2}'

          FASTEST=$(sort -n "$TEMP_RESULTS" | head -n1 | awk '{print $2}')

          echo ""
          echo "‚úÖ ÊúÄÂø´ÁöÑÊ∫êÊòØ: $FASTEST"

          # ÂÜôÂÖ• Job Summary
          echo "## üèÜ ÊúÄÂø´ Ubuntu ÈïúÂÉèÊ∫êÊµãËØïÊä•ÂëäÔºàHTTP ÂìçÂ∫îÊµãÈÄüÔºâ" >> $GITHUB_STEP_SUMMARY
          echo "**ÊúÄÁªàÈÄâÊã© ‚Üí \`$FASTEST\`**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìä ËØ¶ÁªÜÊµãËØïÁªìÊûúÔºàÂâç10ÂêçÔºâ" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          sort -n "$TEMP_RESULTS" | head -n 10 | awk '{printf "%7s   %s\n", $1, $2}' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          # Ê∏ÖÁêÜ
          rm -f "$TEMP_RESULTS"
