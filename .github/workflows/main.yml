name: "测试"
#dsafghj
on:
  workflow_dispatch:
  push:
    branches:
      - "*"
  pull_request:
    branches:
      - "*"
  release:
    types:
      - released
  schedule:
    - cron: "0 0 * * *"
jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      - name: Find and configure fastest Ubuntu mirror
        run: |
          wget http://ftp.de.debian.org/debian/pool/main/n/netselect/netselect_0.3.ds1-29_amd64.deb

          # 安装下载的包
          sudo dpkg -i netselect_0.3.ds1-29_amd64.deb
          
          # 如果安装过程中出现依赖问题，运行以下命令修复：
          sudo apt-get -f install
      - name: 🚀 测试并显示最快的 Ubuntu 源（含完整过程）
        run: |
          echo "⏳ 准备测试环境..."
          # ✅ wget 是系统预装的，无需安装

          echo ""
          echo "🌐 获取官方镜像列表（强制获取完整列表）..."
          MIRRORS=$(wget -qO- "http://mirrors.ubuntu.com/mirrors.txt?all=true")
          MIRROR_COUNT=$(echo "$MIRRORS" | wc -l)
          echo "🔍 共获取到 $MIRROR_COUNT 个镜像源，开始测试..."

          if [ "$MIRROR_COUNT" -lt 2 ]; then
            echo "⚠️  镜像列表过少，补充常用快速镜像..."
            MIRRORS=$(echo -e "$MIRRORS\nhttp://mirrors.aliyun.com/ubuntu/\nhttp://mirrors.tuna.tsinghua.edu.cn/ubuntu/\nhttp://mirror.sjtu.edu.cn/ubuntu/")
            MIRROR_COUNT=$(echo "$MIRRORS" | wc -l)
            echo "📌 补充后共 $MIRROR_COUNT 个镜像源。"
          fi

          echo ""
          echo "📋 镜像源列表："
          echo "$MIRRORS" | nl

          echo ""
          echo "⏱️  正在测试速度（评分越低越好，超时 20 秒）..."
          HOSTS=$(echo "$MIRRORS" | sed -E 's|https?://([^/]+).*|\1|' | sort -u | grep -v '^$')

          if [ -z "$HOSTS" ]; then
            echo "❌ 未提取到有效主机名"
            exit 1
          fi

          RESULT=$(echo "$HOSTS" | xargs -n1 echo | netselect -s 5 -t 20 2>/dev/null || true)

          if [ -z "$RESULT" ]; then
            echo "⚠️  所有镜像测试失败或超时，可能受网络限制。"
            FASTEST="archive.ubuntu.com"
          else
            echo ""
            echo "📊 测试结果（评分 越小越快）："
            echo "$RESULT" | awk '{printf "%4d   %s\n", $1, $2}'
            FASTEST=$(echo "$RESULT" | head -n1 | awk '{print $2}')
          fi

          echo ""
          echo "✅ 最快的源是: $FASTEST"

          echo "## 🏆 最快 Ubuntu 镜像源测试报告" >> $GITHUB_STEP_SUMMARY
          echo "**最终选择 → \`$FASTEST\`**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -n "$RESULT" ]; then
            echo "### 📊 详细测试结果（评分越低越快）" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$RESULT" | awk '{printf "%4d   %s\n", $1, $2}' >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "> ⚠️ 所有测试失败，使用默认源 \`archive.ubuntu.com\`" >> $GITHUB_STEP_SUMMARY
          fi
