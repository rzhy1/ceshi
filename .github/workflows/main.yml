name: "ÊµãËØï Ubuntu ÈïúÂÉèÈÄüÂ∫¶"

on:
  workflow_dispatch:
  push:
    branches: ["*"]
  pull_request:
    branches: ["*"]
  release:
    types: [released]
  schedule:
    - cron: "0 0 * * *"

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      - name: üì¶ ‰ΩøÁî®ÊåáÂÆöÊñπÂºèÂÆâË£Ö netselectÔºà‰ªÖ‰øùÁïôÔºåÂÆûÈôÖ‰∏ç‰æùËµñÔºâ
        run: |
          echo "üì¶ ‰ªçÊåâË¶ÅÊ±ÇÂÆâË£Ö netselectÔºà‰ΩÜÂêéÁª≠ÊµãËØïÊîπÁî® curlÔºâ..."
          wget -q http://ftp.de.debian.org/debian/pool/main/n/netselect/netselect_0.3.ds1-29_amd64.deb
          sudo dpkg -i netselect_0.3.ds1-29_amd64.deb || true
          sudo apt-get -f install -y

      - name: üöÄ ÊµãËØïÂπ∂ÊòæÁ§∫ÊúÄÂø´ÁöÑ Ubuntu Ê∫êÔºà‰ΩøÁî® curl + ÂÜÖÁΩÆÈïúÂÉèÂàóË°®Ôºâ
        env:
          MIRRORS: |
            http://archive.ubuntu.com/ubuntu/
            http://mirrors.aliyun.com/ubuntu/
            http://mirrors.tuna.tsinghua.edu.cn/ubuntu/
            http://mirrors.ustc.edu.cn/ubuntu/
            http://mirror.sjtu.edu.cn/ubuntu/
            http://mirrors.zju.edu.cn/ubuntu/
            http://mirrors.bfsu.edu.cn/ubuntu/
            http://mirror.lzu.edu.cn/ubuntu/
            http://mirror.hust.edu.cn/ubuntu/
            http://mirror.bjtu.edu.cn/ubuntu/
            http://ftp.jaist.ac.jp/pub/Linux/ubuntu/
            http://ftp.iij.ad.jp/pub/linux/ubuntu/
            http://mirror.navercorp.com/ubuntu/
            http://mirror.enzu.com/ubuntu/
            http://mirror.math.princeton.edu/pub/ubuntu/
            http://ubuntu.mirror.constant.com/
        run: |
          echo "‚è≥ ÂáÜÂ§áÊµãËØïÁéØÂ¢É..."

          MIRROR_COUNT=$(echo "$MIRRORS" | wc -l)
          echo "üîç ‰ΩøÁî®ÂÜÖÁΩÆÈïúÂÉèÂàóË°®ÔºåÂÖ± $MIRROR_COUNT ‰∏™ÈïúÂÉèÊ∫êÔºåÂºÄÂßãÊµãËØï..."

          echo ""
          echo "üìã ÈïúÂÉèÊ∫êÂàóË°®Ôºö"
          echo "$MIRRORS" | nl

          echo ""
          echo "‚è±Ô∏è  Ê≠£Âú®ÊµãËØï HTTP ÂìçÂ∫îÈÄüÂ∫¶ÔºàË∂äÂ∞èË∂äÂø´Ôºâ..."

          # ÂàõÂª∫‰∏¥Êó∂Êñá‰ª∂Â≠òÂÇ®ÁªìÊûú
          TEMP_RESULTS=$(mktemp)

          # ÈÄê‰∏™ÊµãËØï
          while IFS= read -r url; do
            [ -z "$url" ] && continue
            host=$(echo "$url" | sed -E 's|https?://([^/]+).*|\1|')
            test_url="${url%/}/README"

            # Ëé∑ÂèñÂéüÂßãÂìçÂ∫îÊó∂Èó¥
            raw_time=$(curl -w "%{time_total}" -o /dev/null -s --connect-timeout 8 --max-time 15 "$test_url" 2>/dev/null)

            # Âà§Êñ≠ÊòØÂê¶ÊúâÊïà
            if [ $? -ne 0 ] || [ -z "$raw_time" ] || [ "$(echo "$raw_time >= 15" | bc -l)" -eq 1 ] || [ "$(echo "$raw_time <= 0" | bc -l)" -eq 1 ]; then
              time_total="999.999"
            else
              # Ê†ºÂºèÂåñ‰∏∫ 3 ‰ΩçÂ∞èÊï∞
              time_total=$(printf "%.3f" "$raw_time" 2>/dev/null || echo "999.999")
              # È™åËØÅÊ†ºÂºèÊòØÂê¶Ê≠£Á°Æ
              if ! echo "$time_total" | grep -E "^[0-9]+\.[0-9]{3}$" >/dev/null; then
                time_total="999.999"
              fi
            fi

            printf "%.3f   %s\n" "$time_total" "$host" >> "$TEMP_RESULTS"
            echo "  ‚Üí $host : ${time_total}s"
          done <<< "$MIRRORS"

          # ÊåâÂìçÂ∫îÊó∂Èó¥ÊéíÂ∫è
          echo ""
          echo "üìä ÊµãËØïÁªìÊûúÔºàÂìçÂ∫îÊó∂Èó¥ÔºåÂçï‰ΩçÔºöÁßíÔºåË∂äÂ∞èË∂äÂ•ΩÔºâÔºö"
          sort -n "$TEMP_RESULTS" | head -n 15 | awk '{printf "%7s   %s\n", $1, $2}'

          FASTEST=$(sort -n "$TEMP_RESULTS" | head -n1 | awk '{print $2}')

          echo ""
          echo "‚úÖ ÊúÄÂø´ÁöÑÊ∫êÊòØ: $FASTEST"

          # ÂÜôÂÖ• Job Summary
          echo "## üèÜ ÊúÄÂø´ Ubuntu ÈïúÂÉèÊ∫êÊµãËØïÊä•ÂëäÔºàHTTP ÂìçÂ∫îÊµãÈÄüÔºâ" >> $GITHUB_STEP_SUMMARY
          echo "**ÊúÄÁªàÈÄâÊã© ‚Üí \`$FASTEST\`**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìä ËØ¶ÁªÜÊµãËØïÁªìÊûúÔºàÂâç15ÂêçÔºâ" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          sort -n "$TEMP_RESULTS" | head -n 15 | awk '{printf "%7s   %s\n", $1, $2}' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          # Ê∏ÖÁêÜ
          rm -f "$TEMP_RESULTS"
