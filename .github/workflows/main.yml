name: "æµ‹è¯•"
#dsafghj
on:
  workflow_dispatch:
  push:
    branches:
      - "*"
  pull_request:
    branches:
      - "*"
  release:
    types:
      - released
  schedule:
    - cron: "0 0 * * *"
jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      - name: Find and configure fastest Ubuntu mirror
        run: |
          wget http://ftp.de.debian.org/debian/pool/main/n/netselect/netselect_0.3.ds1-29_amd64.deb

          # å®‰è£…ä¸‹è½½çš„åŒ…
          sudo dpkg -i netselect_0.3.ds1-29_amd64.deb
          
          # å¦‚æžœå®‰è£…è¿‡ç¨‹ä¸­å‡ºçŽ°ä¾èµ–é—®é¢˜ï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤ä¿®å¤ï¼š
          sudo apt-get -f install
      - name: ðŸš€ æµ‹è¯•å¹¶æ˜¾ç¤ºæœ€å¿«çš„ Ubuntu æºï¼ˆå«å®Œæ•´è¿‡ç¨‹ï¼‰
        run: |
          echo "â³ å‡†å¤‡æµ‹è¯•çŽ¯å¢ƒ..."
          # âœ… wget æ˜¯ç³»ç»Ÿé¢„è£…çš„ï¼Œæ— éœ€å®‰è£…

          echo ""
          echo "ðŸŒ èŽ·å–å®˜æ–¹é•œåƒåˆ—è¡¨ï¼ˆå¼ºåˆ¶èŽ·å–å®Œæ•´åˆ—è¡¨ï¼‰..."
          MIRRORS=$(wget -qO- "http://mirrors.ubuntu.com/mirrors.txt?all=true")
          MIRROR_COUNT=$(echo "$MIRRORS" | wc -l)
          echo "ðŸ” å…±èŽ·å–åˆ° $MIRROR_COUNT ä¸ªé•œåƒæºï¼Œå¼€å§‹æµ‹è¯•..."

          if [ "$MIRROR_COUNT" -lt 2 ]; then
            echo "âš ï¸  é•œåƒåˆ—è¡¨è¿‡å°‘ï¼Œè¡¥å……å¸¸ç”¨å¿«é€Ÿé•œåƒ..."
            MIRRORS=$(echo -e "$MIRRORS\nhttp://mirrors.aliyun.com/ubuntu/\nhttp://mirrors.tuna.tsinghua.edu.cn/ubuntu/\nhttp://mirror.sjtu.edu.cn/ubuntu/")
            MIRROR_COUNT=$(echo "$MIRRORS" | wc -l)
            echo "ðŸ“Œ è¡¥å……åŽå…± $MIRROR_COUNT ä¸ªé•œåƒæºã€‚"
          fi

          echo ""
          echo "ðŸ“‹ é•œåƒæºåˆ—è¡¨ï¼š"
          echo "$MIRRORS" | nl

          echo ""
          echo "â±ï¸  æ­£åœ¨æµ‹è¯•é€Ÿåº¦ï¼ˆè¯„åˆ†è¶Šä½Žè¶Šå¥½ï¼Œè¶…æ—¶ 20 ç§’ï¼‰..."
          HOSTS=$(echo "$MIRRORS" | sed -E 's|https?://([^/]+).*|\1|' | sort -u | grep -v '^$')

          if [ -z "$HOSTS" ]; then
            echo "âŒ æœªæå–åˆ°æœ‰æ•ˆä¸»æœºå"
            exit 1
          fi

          RESULT=$(echo "$HOSTS" | xargs -n1 echo | netselect -s 5 -t 20 2>/dev/null || true)

          if [ -z "$RESULT" ]; then
            echo "âš ï¸  æ‰€æœ‰é•œåƒæµ‹è¯•å¤±è´¥æˆ–è¶…æ—¶ï¼Œå¯èƒ½å—ç½‘ç»œé™åˆ¶ã€‚"
            FASTEST="archive.ubuntu.com"
          else
            echo ""
            echo "ðŸ“Š æµ‹è¯•ç»“æžœï¼ˆè¯„åˆ† è¶Šå°è¶Šå¿«ï¼‰ï¼š"
            echo "$RESULT" | awk '{printf "%4d   %s\n", $1, $2}'
            FASTEST=$(echo "$RESULT" | head -n1 | awk '{print $2}')
          fi

          echo ""
          echo "âœ… æœ€å¿«çš„æºæ˜¯: $FASTEST"

          echo "## ðŸ† æœ€å¿« Ubuntu é•œåƒæºæµ‹è¯•æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "**æœ€ç»ˆé€‰æ‹© â†’ \`$FASTEST\`**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -n "$RESULT" ]; then
            echo "### ðŸ“Š è¯¦ç»†æµ‹è¯•ç»“æžœï¼ˆè¯„åˆ†è¶Šä½Žè¶Šå¿«ï¼‰" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$RESULT" | awk '{printf "%4d   %s\n", $1, $2}' >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "> âš ï¸ æ‰€æœ‰æµ‹è¯•å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æº \`archive.ubuntu.com\`" >> $GITHUB_STEP_SUMMARY
          fi
