name: "æµ‹è¯•"
#dsafghj
on:
  workflow_dispatch:
  push:
    branches:
      - "*"
  pull_request:
    branches:
      - "*"
  release:
    types:
      - released
  schedule:
    - cron: "0 0 * * *"
jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      - name: Find and configure fastest Ubuntu mirror
        run: |
          wget http://ftp.de.debian.org/debian/pool/main/n/netselect/netselect_0.3.ds1-29_amd64.deb

          # å®‰è£…ä¸‹è½½çš„åŒ…
          sudo dpkg -i netselect_0.3.ds1-29_amd64.deb
          
          # å¦‚æžœå®‰è£…è¿‡ç¨‹ä¸­å‡ºçŽ°ä¾èµ–é—®é¢˜ï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤ä¿®å¤ï¼š
          sudo apt-get -f install
          echo ""
          echo "ðŸŒ èŽ·å–å®˜æ–¹é•œåƒåˆ—è¡¨..."
          MIRRORS=$(wget -qO- mirrors.ubuntu.com/mirrors.txt)
          MIRROR_COUNT=$(echo "$MIRRORS" | wc -l)
          echo "ðŸ” å…±èŽ·å–åˆ° $MIRROR_COUNT ä¸ªé•œåƒæºï¼Œå¼€å§‹æµ‹è¯•..."

          echo ""
          echo "ðŸ“‹ é•œåƒæºåˆ—è¡¨ï¼š"
          echo "$MIRRORS" | nl

          echo ""
          echo "â±ï¸  æ­£åœ¨æµ‹è¯•é€Ÿåº¦ï¼ˆè¯„åˆ†è¶Šä½Žè¶Šå¥½ï¼Œè¶…æ—¶ 20 ç§’ï¼‰..."
          # æå–ä¸»æœºåï¼ˆåŽ»æŽ‰åè®®å’Œè·¯å¾„ï¼‰ï¼Œç”¨äºŽ netselect
          HOSTS=$(echo "$MIRRORS" | sed -E 's|https?://([^/]+).*|\1|' | sort -u)

          # æµ‹è¯•å¹¶ä¿ç•™åŽŸå§‹è¾“å‡º
          RESULT=$(echo "$HOSTS" | xargs -n1 echo | netselect -s 5 -t 20 2>/dev/null)

          if [ -z "$RESULT" ]; then
            echo "âš ï¸  æ‰€æœ‰é•œåƒæµ‹è¯•å¤±è´¥ï¼Œå¯èƒ½å—ç½‘ç»œé™åˆ¶ã€‚"
            FASTEST="archive.ubuntu.com"
          else
            echo ""
            echo "ðŸ“Š æµ‹è¯•ç»“æžœï¼ˆè¯„åˆ† è¶Šå°è¶Šå¿«ï¼‰ï¼š"
            echo "$RESULT" | awk '{printf "%4d   %s\n", $1, $2}'
            
            FASTEST=$(echo "$RESULT" | head -n1 | awk '{print $2}')
          fi

          echo ""
          echo "âœ… æœ€å¿«çš„æºæ˜¯: $FASTEST"

          # å†™å…¥ Job Summaryï¼ˆGitHub Actions ç•Œé¢å³ä¾§é†’ç›®æ˜¾ç¤ºï¼‰
          echo "## ðŸ† æœ€å¿« Ubuntu é•œåƒæºæµ‹è¯•æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "**æœ€ç»ˆé€‰æ‹© â†’ \`$FASTEST\`**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š è¯¦ç»†æµ‹è¯•ç»“æžœï¼ˆè¯„åˆ†è¶Šä½Žè¶Šå¿«ï¼‰" >> $GITHUB_STEP_SUMSUMMARY
          if [ -n "$RESULT" ]; then
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$RESULT" | awk '{printf "%4d   %s\n", $1, $2}' >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "> æ‰€æœ‰æµ‹è¯•å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æº \`archive.ubuntu.com\`" >> $GITHUB_STEP_SUMMARY
          fi
