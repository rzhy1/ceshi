name: "æµ‹è¯•"

on:
  workflow_dispatch:
  push:
    branches: ["*"]
  pull_request:
    branches: ["*"]
  release:
    types: [released]
  schedule:
    - cron: "0 0 * * *"

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      - name: ğŸ“¦ ä½¿ç”¨æŒ‡å®šæ–¹å¼å®‰è£… netselectï¼ˆä»…ä¿ç•™ï¼Œå®é™…ä¸ä¾èµ–ï¼‰
        run: |
          echo "ğŸ“¦ ä»æŒ‰è¦æ±‚å®‰è£… netselectï¼ˆä½†åç»­æµ‹è¯•æ”¹ç”¨ curlï¼‰..."
          wget -q http://ftp.de.debian.org/debian/pool/main/n/netselect/netselect_0.3.ds1-29_amd64.deb
          sudo dpkg -i netselect_0.3.ds1-29_amd64.deb || true
          sudo apt-get -f install -y

      - name: ğŸš€ æµ‹è¯•å¹¶æ˜¾ç¤ºæœ€å¿«çš„ Ubuntu æºï¼ˆä½¿ç”¨ curl + å†…ç½®é•œåƒåˆ—è¡¨ï¼‰
        run: |
          echo "â³ å‡†å¤‡æµ‹è¯•ç¯å¢ƒ..."

          # âœ… æ‰‹åŠ¨å®šä¹‰é•œåƒåˆ—è¡¨ï¼ˆå…¨çƒ + å›½å†…é«˜é€Ÿæºï¼‰
          # æ¥æºï¼šå®˜æ–¹æ¨è + æ¸…åã€é˜¿é‡Œã€ä¸­ç§‘å¤§ã€ä¸Šäº¤ç­‰å›½å†…é«˜æ ¡/ä¼ä¸šé•œåƒ
          MIRRORS=$(cat <<EOF
http://archive.ubuntu.com/ubuntu/
http://mirrors.aliyun.com/ubuntu/
http://mirrors.tuna.tsinghua.edu.cn/ubuntu/
http://mirrors.ustc.edu.cn/ubuntu/
http://mirror.sjtu.edu.cn/ubuntu/
http://mirrors.zju.edu.cn/ubuntu/
http://mirrors.bfsu.edu.cn/ubuntu/
http://mirror.lzu.edu.cn/ubuntu/
http://mirror.hust.edu.cn/ubuntu/
http://mirror.bjtu.edu.cn/ubuntu/
http://ftp.jaist.ac.jp/pub/Linux/ubuntu/
http://ftp.iij.ad.jp/pub/linux/ubuntu/
http://mirror.navercorp.com/ubuntu/
http://mirror.enzu.com/ubuntu/
http://mirror.math.princeton.edu/pub/ubuntu/
http://ubuntu.mirror.constant.com/
EOF
          )

          MIRROR_COUNT=$(echo "$MIRRORS" | wc -l)
          echo "ğŸ” ä½¿ç”¨å†…ç½®é•œåƒåˆ—è¡¨ï¼Œå…± $MIRROR_COUNT ä¸ªé•œåƒæºï¼Œå¼€å§‹æµ‹è¯•..."

          echo ""
          echo "ğŸ“‹ é•œåƒæºåˆ—è¡¨ï¼š"
          echo "$MIRRORS" | nl

          echo ""
          echo "â±ï¸  æ­£åœ¨æµ‹è¯• HTTP å“åº”é€Ÿåº¦ï¼ˆè¶Šå°è¶Šå¿«ï¼‰..."

          # åˆ›å»ºä¸´æ—¶æ–‡ä»¶å­˜å‚¨ç»“æœ
          TEMP_RESULTS=$(mktemp)

          # é€ä¸ªæµ‹è¯•
          while IFS= read -r url; do
            [ -z "$url" ] && continue
            # æå–ä¸»æœºåç”¨äºæ˜¾ç¤º
            host=$(echo "$url" | sed -E 's|https?://([^/]+).*|\1|')
            # æµ‹è¯•è½»é‡æ–‡ä»¶ï¼ˆé¿å…ä¸‹è½½å¤§æ–‡ä»¶ï¼‰
            test_url="${url%/}/README"
            time_total=$(curl -w "%{time_total}" -o /dev/null -s --connect-timeout 8 --max-time 15 "$test_url" 2>/dev/null || echo "999.999")
            # é˜²æ­¢ 0.000 è¯¯åˆ¤
            [ "$time_total" = "0.000" ] && time_total="999.999"
            printf "%.3f   %s\n" "$time_total" "$host" >> "$TEMP_RESULTS"
            echo "  â†’ $host : ${time_total}s"
          done <<< "$MIRRORS"

          # æŒ‰å“åº”æ—¶é—´æ’åº
          echo ""
          echo "ğŸ“Š æµ‹è¯•ç»“æœï¼ˆå“åº”æ—¶é—´ï¼Œå•ä½ï¼šç§’ï¼Œè¶Šå°è¶Šå¥½ï¼‰ï¼š"
          sort -n "$TEMP_RESULTS" | head -n 15 | awk '{printf "%7s   %s\n", $1, $2}'

          FASTEST=$(sort -n "$TEMP_RESULTS" | head -n1 | awk '{print $2}')

          echo ""
          echo "âœ… æœ€å¿«çš„æºæ˜¯: $FASTEST"

          # å†™å…¥ Job Summary
          echo "## ğŸ† æœ€å¿« Ubuntu é•œåƒæºæµ‹è¯•æŠ¥å‘Šï¼ˆHTTP å“åº”æµ‹é€Ÿï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "**æœ€ç»ˆé€‰æ‹© â†’ \`$FASTEST\`**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š è¯¦ç»†æµ‹è¯•ç»“æœï¼ˆå‰15åï¼‰" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          sort -n "$TEMP_RESULTS" | head -n 15 | awk '{printf "%7s   %s\n", $1, $2}' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          # æ¸…ç†
          rm -f "$TEMP_RESULTS"
